<?php

/**
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class Issue extends BaseIssue
{
  public $snapshot;

  public function isClosed()
  {
    return $this->is_closed;
  }

  public function isResolved()
  {
    return $this->is_resolved;
  }

  public function setCurrEstimate($estimate)
  {
    if (!$this->orig_estimate) {
      $this->orig_estimate = $estimate;
    }
    return $this->_set('curr_estimate', $estimate);
  }

  public function setIsResolved($is_resolved)
  {
    if ($is_resolved) {
      $this->resolved_at = date('Y-m-d H:i:s');
      $this->resolved_by = Listener_Userstampable::getCurrentUserId();
    } else {
      $this->resolved_at = null;
      $this->resolved_by = null;
      $this->setIsClosed(false);
      // if reopened, then assigned opened_by to the person who did it
      $this->opened_by = Listener_Userstampable::getCurrentUserId();
    }
    return $this->_set('is_resolved', $is_resolved);
  }

  public function setIsClosed($is_closed)
  {
    if ($is_closed) {
      $this->closed_at = date('Y-m-d H:i:s');
      $this->closed_by = Listener_Userstampable::getCurrentUserId();
    } else {
      $this->closed_at = null;
      $this->closed_by = null;
    }
    return $this->_set('is_closed', $is_closed);
  }

  public function setStatusId($status_id)
  {
    if ($status_id != $this->status_id) {
      if (StatusTable::isResolved($status_id)) {
        $this->setIsResolved(true);
      } else {
        $this->setIsResolved(false);
      }
    }
    $this->_set('status_id', $status_id);
  }

  public function getPrimaryContact()
  {
    $owner = false;
    if (isset($this->component_id)) {
      $owner = Doctrine::getTable('Component')->getOwner($this->component_id);
    }
    if ($owner === false && isset($this->project_id)) {
      $owner = Doctrine::getTable('Project')->getOwner($this->project_id);
    }
    return ($owner !== false) ? $owner : null;
  }

  public function takeSnapshot()
  {
    $this->snapshot = $this->toArray(true);
  }

  /**
   * pre: take snapshot must be called before this method
   */
  public function addActivityNote($note)
  {
    $activity = new IssueActivity();
    $activity->body = $note;
    $activity->setIssueAndChanges($this, $this->snapshot);

    if (!$this->hasReference('Activities')) {
      $this->Activities = new Doctrine_Collection('IssueActivity');
    }
    $this->Activities->add($activity);
  }

  public function preInsert($event)
  {
    $modified = $this->getModified();
    if (!array_key_exists('opened_at', $modified))
    {
      $this->opened_at = date('Y-m-d H:i:s');
    }
    if (!array_key_exists('opened_by', $modified))
    {
      $this->opened_by = Listener_Userstampable::getCurrentUserId();
    }
  }

  public function preSave($event)
  {
    if (!$this->assigned_to) {
      $this->AssignedTo = $this->getPrimaryContact();
    }
  }
}

